' Gambas class file

Public MLI As Label[]
Public MTI As TextBox[]
Public AktivModulePath As String[]
Public ScrollView1 As ScrollView

Public Sub Button1_Click()
  
  Dim s As String
  
  FScoarboardPreview.Show()
  FScoarboardPreview.x = Me.x + Me.w
  SetXML()
  Print "test"
  FScoarboardPreview.makeFinishOverlay("/tmp/Images.xml", "/tmp/Text.xml", ButtonBox1.text)
  
End

Public Sub Form_Show()
  
  Dim s As String[]
  Dim xml As XmlDocument
  
  AktivModulePath = New String[]
  MTI = New TextBox[]
  MLI = New Label[]
  ScrollView1 = New ScrollView(Me)
  
  With ScrollView1
    .x = 0
    .y = 42
    .w = 448
    .H = 168
    
  End With
  
  ' ActivModulePath = Split(File.Load(User.Home & "/.scoreboard/AktivModule.mod"), "|")
  s = Split(File.Load(User.home & "/.Scoreboard/Config.module"), "/|", "", True)
  While s.Count > 0 
    If s[0] = "Basic" Then s[1] = "False"
    If Val(s[1]) Then
      
      If Exist(User.home & "/.local/lib/scoreboard/module/" & s[0]) Then
        AktivModulePath.Add(User.home & "/.local/lib/scoreboard/module/" & s[0])
      Else
        AktivModulePath.Add("/usr/lib/Scoarbord/module/" & s[0])
      Endif
    Endif
    s.Remove(0)
    s.Remove(0)
  Wend
  Print s
  loadModule(AktivModulePath)
  
End

Public Sub loadModule(AktivModulePat As String[])
  
  Dim s As String
  Dim Xml As XmlDocument
  Dim Elements As XmlElement[]
  Dim Element As XmlElement
  Dim t As TextBox
  Dim lastY As Integer
  Dim l As Label
  
  lastY = 0
  
  For Each s In AktivModulePat
    Xml = New XmlDocument(s & "/ModuleCall.xml")
    Elements = Xml.GetElementsByTagName("Text")
    For Each Element In Elements
      t = New TextBox(ScrollView1)
      With t
        .Tag = Element.GetAttribute("Description")
        .Tooltip = Element.GetAttribute("Description")
        .h = 28
        .w = 112
        .x = 5
        .y = 5 + lastY 
      End With
      l = New Label(ScrollView1)
      With l
        .Tag = Element.GetAttribute("Description")
        .Text = Element.GetAttribute("Description")
        .h = 28
        .w = 112
        .x = 5 + t.w + 5
        .y = 5 + lastY 
      End With
      lastY = t.Y + t.h
      MTI.Add(t)
    Next
  Next
  
End

Public Sub ButtonBox1_Click()
  
  Dialog.Title = Label5.Text
  Dialog.Filter = ["*.png", "PNG Pictures"]
  If Not Dialog.SaveFile() Then ButtonBox1.text = Dialog.Path 
  
End

Public Sub SetXML()
  
  Dim Doc As XmlDocument
  Dim s As String
  Dim XmlModule As XmlDocument
  Dim xModuleElement As XmlElement
  Dim Element As XmlElement
  Dim txtb As TextBox
  Dim Elements As XmlElement[]
  
  Doc = New XmlDocument
  Element = New XmlElement("Text")
  
  For Each s In AktivModulePath
    Doc.Root.AppendChild(Doc.CreateElement("Debug"))  
    
    Elements = xmlfill(s)
    
    For Each Element In Elements
      
      Doc.Root.AppendChild(Element)
    Next
    XmlModule = New XmlDocument(s & "/ModuleCall.xml")
    For Each xModuleElement In XmlModule.GetElementsByTagName("Images")
      xModuleElement.SetAttribute("IMGPath", s & "/" & xModuleElement.GetAttribute("IMGPath"))
      Doc.Root.AppendChild(xModuleElement)
    Next
    
  Next
  Print Doc.Content
  Doc.Save("/tmp/Images.xml")
  
End

Public Sub xmlfill(s As String) As XmlElement[]
  
  Dim XmlModule As XmlDocument
  Dim xModuleElement As XmlElement
  Dim txtb As TextBox
  Dim Element As XmlElement
  Dim Elements As XmlElement[]
  Dim xml As XmlDocument
  
  xml = New XmlDocument
  Elements = New XmlElement[]
  XmlModule = New XmlDocument(s & "/ModuleCall.xml")
  For Each xModuleElement In XmlModule.GetElementsByTagName("Text")
    
    For Each txtb In MTI
      
      If txtb.tag = xModuleElement.GetAttribute("Description") Then
        Element = New XmlElement("Text")
        Element.SetAttribute("Text", txtb.Text)
        Element.SetAttribute("X", xModuleElement.GetAttribute("X"))
        Element.SetAttribute("Y", xModuleElement.GetAttribute("Y"))
        Element.SetAttribute("Font", xModuleElement.GetAttribute("Font"))
        Elements.Add(Element)
        Break
      Endif
      
    Next
    Element = New XmlElement("Text")
    Element.SetAttribute("Text", TournamentRound.Text)
    Element.SetAttribute("X", TRX.Text)
    Element.SetAttribute("Y", TRY.text)
    Element.SetAttribute("Font", "Sans Serif,58")
    Elements.Add(Element)
    Element = New XmlElement("Text")
    Element.SetAttribute("Text", Tournament.Text)
    Element.SetAttribute("X", TX.Text)
    Element.SetAttribute("Y", TY.Text)
    Element.SetAttribute("Font", "Sans Serif,58")
    Elements.Add(Element)
  Next
  
  For Each Element In Elements
    xml.Root.AppendChild(Element)
  Next
  xml.Save("/tmp/Text.xml")
  Elements = New XmlElement[]
  Return Elements
  
End